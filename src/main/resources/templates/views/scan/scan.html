<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{views/layout :: head}">
    <!--/*@thymesVar id="pageTitle" type="java.lang.String"*/-->
    <title th:text="${pageTitle} ?: 'ScanKorea'">ScanKorea</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body class="bg-gray-50 dark:bg-slate-900">
<main th:fragment="~{views/layout :: content}">
    <section class="w-full max-w-md bg-white dark:bg-slate-800 rounded-2xl shadow-md p-5 sm:p-6 md:p-8 mx-auto my-6">
        <!-- Error message -->
        <div th:if="${error}"
             class="bg-red-50 border border-red-200 text-red-700 text-center rounded-lg py-3 px-4 mb-4"
             th:text="${error}">
            There was an error scanning the barcode.
        </div>

        <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-2">Scan a Barcode / QR</h1>
        <p class="text-sm text-gray-500 mb-4">Choose a method below. Works on iOS & Android in modern mobile
            browsers.</p>

        <!-- Method selector -->
        <div class="grid grid-cols-2 gap-2 mb-4" role="tablist" aria-label="Upload method">
            <button id="tab-upload" data-tab="upload"
                    class="tab-btn aria-selected:bg-brand aria-selected:text-white bg-gray-100 dark:bg-slate-700 text-gray-800 dark:text-gray-100 rounded-xl py-2 font-medium focus:outline-none focus:ring"
                    aria-selected="true" role="tab">Gallery
            </button>
            <button id="tab-camera" data-tab="camera"
                    class="tab-btn bg-gray-100 dark:bg-slate-700 text-gray-800 dark:text-gray-100 rounded-xl py-2 font-medium focus:outline-none focus:ring"
                    aria-selected="false" role="tab">Camera
            </button>
        </div>

        <!-- Upload: Gallery file input (universal) -->
        <form id="form-upload"
              hx-post="/hx/scan"
              hx-encoding="multipart/form-data"
              hx-swap="none"
              hx-indicator="#scan-loading"
              hx-disabled-elt="button[type='submit']"
              class="space-y-4"
              role="tabpanel"
              aria-labelledby="tab-upload">
            <!-- Language selection -->
            <div>
                <label for="lang-upload" class="block font-semibold mb-2 text-gray-700 dark:text-gray-200">üåç Choose
                    Language</label>
                <select id="lang-upload" name="lang" required
                        class="w-full border border-gray-300 dark:border-slate-600 bg-gray-50 dark:bg-slate-700 text-gray-800 dark:text-gray-100 rounded-lg p-3">
                    <option th:each="lc : ${T(com.scankorea.server.common.constant.LanguageCode).values()}"
                            th:value="${lc}"
                            th:text="${lc}"
                            th:attrappend="selected=${lc.name() == 'EN'}">EN
                    </option>
                </select>
            </div>

            <div>
                <label for="file-upload" class="block font-semibold mb-2 text-gray-700 dark:text-gray-200">üìÅ Upload from
                    Gallery</label>
                <div id="dropZone"
                     class="border-2 border-dashed border-brand/70 bg-brand/5 text-gray-500 text-center rounded-xl py-10 px-4 transition hover:bg-brand/10 cursor-pointer">
                    <div>Tap to select or drag a photo here</div>
                    <div id="fileName" class="text-sm text-gray-500 mt-2">No file selected</div>
                </div>
                <!-- Gallery preview -->
                <div id="galleryPreviewWrap" class="hidden mt-3">
                    <img id="galleryPreview" alt="Selected image preview" class="w-full rounded-xl"/>
                </div>
                <!-- Standard file input (gallery) -->
                <input id="file-upload" type="file" name="file" accept="image/*" hidden required>
            </div>

            <button type="submit"
                    class="w-full bg-brand hover:bg-blue-700 text-white font-semibold rounded-xl py-3 mt-2 shadow-sm transition">
                Scan Barcode
            </button>
        </form>

        <!-- Camera: two strategies -->
        <!-- Strategy A: In-browser live camera via getUserMedia (best UX) -->
        <!-- Strategy B: Native file input with capture attribute as robust fallback (esp. iOS Safari) -->
        <section id="panel-camera" class="hidden space-y-4" role="tabpanel" aria-labelledby="tab-camera">
            <!-- Language selection (camera) -->
            <div>
                <label for="lang-camera" class="block font-semibold mb-2 text-gray-700 dark:text-gray-200">üåç Choose
                    Language</label>
                <select id="lang-camera"
                        class="w-full border border-gray-300 dark:border-slate-600 bg-gray-50 dark:bg-slate-700 text-gray-800 dark:text-gray-100 rounded-lg p-3">
                    <option th:each="lc : ${T(com.scankorea.server.common.constant.LanguageCode).values()}"
                            th:value="${lc}"
                            th:text="${lc}"
                            th:attrappend="selected=${lc.name() == 'EN'}">EN
                    </option>
                </select>
            </div>

            <!-- A. Live camera (if supported) -->
            <div id="liveWrap" class="rounded-xl border border-gray-200 dark:border-slate-700 p-3">
                <div class="flex items-center justify-between mb-2">
                    <div class="font-semibold text-gray-700 dark:text-gray-200">Live Camera</div>
                    <span id="liveBadge"
                          class="text-xs px-2 py-1 rounded bg-gray-100 dark:bg-slate-700">Checking...</span>
                </div>
                <div class="relative aspect-[3/4] rounded-xl overflow-hidden bg-black">
                    <video id="video" playsinline autoplay class="w-full h-full object-cover"></video>
                    <!-- framing guides -->
                    <div class="pointer-events-none absolute inset-0 grid grid-cols-3 grid-rows-3">
                        <div class="border border-white/20 col-span-3 row-span-3"></div>
                    </div>
                </div>
                <div class="flex gap-2 mt-3">
                    <button id="btnStart"
                            class="flex-1 rounded-xl py-2 font-semibold bg-gray-900 text-white disabled:opacity-50">
                        Start
                    </button>
                    <button id="btnCapture"
                            class="flex-1 rounded-xl py-2 font-semibold bg-brand text-white disabled:opacity-50"
                            disabled>Capture
                    </button>
                    <button id="btnRetake"
                            class="flex-1 rounded-xl py-2 font-semibold bg-gray-200 dark:bg-slate-700 disabled:opacity-50"
                            disabled>Retake
                    </button>
                </div>
                <canvas id="canvas" class="hidden"></canvas>
            </div>

            <div id="previewWrap" class="hidden">
                <img id="previewImg" alt="Captured preview" class="w-full rounded-xl"/>
            </div>

            <!-- Submit captured image to /scan -->
            <button id="btnUploadCapture"
                    class="w-full bg-brand hover:bg-blue-700 text-white font-semibold rounded-xl py-3 shadow-sm transition disabled:opacity-50"
                    disabled>
                Upload & Scan
            </button>

            <!-- B. Native capture fallback (robust on iOS/Android) -->
            <div class="pt-3 border-t border-dashed border-gray-300 dark:border-slate-700">
                <p class="text-xs text-gray-500 mb-2">If live camera isn‚Äôt supported, use native capture:</p>
                <form id="form-native"
                      hx-post="/hx/scan"
                      hx-encoding="multipart/form-data"
                      hx-swap="none"
                      hx-indicator="#scan-loading"
                      hx-disabled-elt="button[type='submit']"
                      class="space-y-2">
                    <input type="hidden" name="lang" id="lang-native"/>
                    <label for="file-native" class="block font-medium text-gray-700 dark:text-gray-200">Native
                        Camera</label>
                    <!-- Important: capture attribute helps open camera on mobile browsers -->
                    <input id="file-native" type="file" name="file" accept="image/*;capture=camera"
                           capture="environment" class="block w-full text-sm"/>
                    <!-- Native capture preview -->
                    <div id="nativePreviewWrap" class="hidden mt-2">
                        <img id="nativePreview" alt="Captured image preview" class="w-full rounded-xl"/>
                    </div>
                    <button type="submit" class="w-full bg-gray-900 text-white rounded-xl py-2 font-semibold">Scan with
                        Native Capture
                    </button>
                </form>
                <p id="fallbackNote" class="text-[11px] text-amber-600 mt-1 hidden">Live camera not available. Using
                    native capture instead.</p>
            </div>
        </section>

        <p class="text-center text-xs text-gray-500 mt-5">Tip: Use clear lighting and keep the code centered.</p>
    </section>

    <script>
        // --- Utilities ---
        const qs = (s, r = document) => r.querySelector(s);
        const qsa = (s, r = document) => Array.from(r.querySelectorAll(s));

        // Helper: swap whole document with returned HTML from Spring MVC (view name -> HTML)
        async function submitAndReplace(formData, action) {
            const res = await fetch(action || '/scan', {method: 'POST', body: formData});
            const html = await res.text();
            document.open();
            document.write(html);
            document.close();
        }

        // Helper: convert Blob to File
        function asFile(blob, filename = `image-${Date.now()}.jpg`) {
            return new File([blob], filename, {type: 'image/jpeg'});
        }

        // --- Tab logic ---
        const tabUpload = qs('#tab-upload');
        const tabCamera = qs('#tab-camera');
        const formUpload = qs('#form-upload');
        const panelCamera = qs('#panel-camera');

        function selectTab(which) {
            if (which === 'upload') {
                formUpload.classList.remove('hidden');
                panelCamera.classList.add('hidden');
                tabUpload.setAttribute('aria-selected', 'true');
                tabCamera.setAttribute('aria-selected', 'false');
            } else {
                formUpload.classList.add('hidden');
                panelCamera.classList.remove('hidden');
                tabUpload.setAttribute('aria-selected', 'false');
                tabCamera.setAttribute('aria-selected', 'true');
            }
        }

        tabUpload.addEventListener('click', () => selectTab('upload'));
        tabCamera.addEventListener('click', () => selectTab('camera'));

        // Default to upload tab
        selectTab('upload');

        // --- EXIF-aware downscale utility (for File or HTMLVideoElement) ---
        const canvas = qs('#canvas');

        async function blobFromSource(src, opts = {}) {
            const {maxDim = 1600, quality = 0.85} = opts;
            if (src instanceof File || src instanceof Blob) {
                if (window.createImageBitmap) {
                    const bmp = await createImageBitmap(src, {imageOrientation: 'from-image'});
                    const w = bmp.width, h = bmp.height;
                    const scale = Math.min(1, maxDim / Math.max(w, h));
                    const cw = Math.max(1, Math.round(w * scale));
                    const ch = Math.max(1, Math.round(h * scale));
                    canvas.width = cw;
                    canvas.height = ch;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(bmp, 0, 0, cw, ch);
                    bmp.close && bmp.close();
                } else {
                    const url = URL.createObjectURL(src);
                    const img = await new Promise((res, rej) => {
                        const i = new Image();
                        i.onload = () => res(i);
                        i.onerror = rej;
                        i.src = url;
                    });
                    const w = img.naturalWidth, h = img.naturalHeight;
                    const scale = Math.min(1, maxDim / Math.max(w, h));
                    const cw = Math.max(1, Math.round(w * scale));
                    const ch = Math.max(1, Math.round(h * scale));
                    canvas.width = cw;
                    canvas.height = ch;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, cw, ch);
                    URL.revokeObjectURL(url);
                }
            } else if (src instanceof HTMLVideoElement) {
                const vw = src.videoWidth, vh = src.videoHeight;
                const scale = Math.min(1, maxDim / Math.max(vw, vh));
                const cw = Math.max(1, Math.round(vw * scale));
                const ch = Math.max(1, Math.round(vh * scale));
                canvas.width = cw;
                canvas.height = ch;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(src, 0, 0, cw, ch);
            } else {
                throw new Error('Unsupported source for blobFromSource');
            }
            const blob = await new Promise((resolve) => canvas.toBlob((b) => resolve(b), 'image/jpeg', quality));
            const previewURL = canvas.toDataURL('image/jpeg', Math.min(quality + 0.1, 0.92));
            return {blob, previewURL};
        }

        // --- Drag & drop for Gallery ---
        const drop = qs('#dropZone');
        const inputUpload = qs('#file-upload');
        const fileNameEl = qs('#fileName');
        const galleryPreviewWrap = qs('#galleryPreviewWrap');
        const galleryPreview = qs('#galleryPreview');
        let galleryProcessed = null; // {blob, previewURL}

        function showGalleryPreview(previewURL) {
            if (!previewURL) {
                galleryPreviewWrap.classList.add('hidden');
                return;
            }
            galleryPreview.src = previewURL;
            galleryPreviewWrap.classList.remove('hidden');
        }

        drop.addEventListener('click', () => inputUpload.click());
        drop.addEventListener('dragover', (e) => {
            e.preventDefault();
            drop.classList.add('bg-brand/10');
        });
        drop.addEventListener('dragleave', () => drop.classList.remove('bg-brand/10'));
        drop.addEventListener('drop', async (e) => {
            e.preventDefault();
            drop.classList.remove('bg-brand/10');
            const file = e.dataTransfer.files && e.dataTransfer.files[0];
            if (file) {
                const processed = await blobFromSource(file, {maxDim: 1600, quality: 0.85});
                galleryProcessed = processed;
                // Replace the file input with optimized File so native form submit hits Spring controller directly
                const dt = new DataTransfer();
                dt.items.add(asFile(processed.blob, file.name.replace(/\.[^.]+$/, '') + '-optimized.jpg'));
                inputUpload.files = dt.files;
                fileNameEl.textContent = dt.files[0].name;
                showGalleryPreview(processed.previewURL);
            }
        });

        inputUpload.addEventListener('change', async () => {
            const file = inputUpload.files && inputUpload.files[0];
            fileNameEl.textContent = file ? file.name : 'No file selected';
            if (file) {
                const processed = await blobFromSource(file, {maxDim: 1600, quality: 0.85});
                galleryProcessed = processed;
                const dt = new DataTransfer();
                dt.items.add(asFile(processed.blob, file.name.replace(/\.[^.]+$/, '') + '-optimized.jpg'));
                inputUpload.files = dt.files;
                fileNameEl.textContent = dt.files[0].name;
                showGalleryPreview(processed.previewURL);
            } else {
                showGalleryPreview(null);
            }
        });

        // --- Camera: capability detection & UX ---
        const isSecureContext = window.isSecureContext === true; // HTTPS required for getUserMedia
        const hasMediaDevices = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);

        const liveBadge = qs('#liveBadge');
        const btnStart = qs('#btnStart');
        const btnCapture = qs('#btnCapture');
        const btnRetake = qs('#btnRetake');
        const btnUploadCapture = qs('#btnUploadCapture');
        const video = qs('#video');
        const previewWrap = qs('#previewWrap');
        const previewImg = qs('#previewImg');
        const fallbackNote = qs('#fallbackNote');

        let stream = null;
        let capturedBlob = null;

        function setLiveState(state) {
            const map = {
                checking: 'Checking...',
                ready: 'Ready',
                unsupported: 'Unavailable',
                active: 'Live',
                captured: 'Captured'
            };
            liveBadge.textContent = map[state] || '...';
        }

        async function checkCameraSupport() {
            setLiveState('checking');
            if (!isSecureContext || !hasMediaDevices) {
                setLiveState('unsupported');
                disableLiveCameraUI();
                return false;
            }
            try {
                const test = await navigator.mediaDevices.getUserMedia({video: true});
                test.getTracks().forEach(t => t.stop());
                setLiveState('ready');
                enableLiveCameraUI();
                return true;
            } catch {
                setLiveState('unsupported');
                disableLiveCameraUI();
                return false;
            }
        }

        function enableLiveCameraUI() {
            btnStart.disabled = false;
            fallbackNote.classList.add('hidden');
        }

        function disableLiveCameraUI() {
            btnStart.disabled = true;
            btnCapture.disabled = true;
            btnRetake.disabled = true;
            btnUploadCapture.disabled = true;
            fallbackNote.classList.remove('hidden');
        }

        async function startLive() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {facingMode: {ideal: 'environment'}},
                    audio: false
                });
                video.srcObject = stream;
                setLiveState('active');
                btnCapture.disabled = false;
                btnRetake.disabled = true;
                btnUploadCapture.disabled = true;
                previewWrap.classList.add('hidden');
                capturedBlob = null;
            } catch {
                setLiveState('unsupported');
                disableLiveCameraUI();
            }
        }

        function stopLive() {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
        }

        async function downscaleFromVideo(videoEl) {
            return blobFromSource(videoEl, {maxDim: 1600, quality: 0.85});
        }

        btnStart.addEventListener('click', startLive);

        btnCapture.addEventListener('click', async () => {
            if (!video.videoWidth) return;
            const processed = await downscaleFromVideo(video);
            capturedBlob = processed.blob;
            previewImg.src = processed.previewURL;
            previewWrap.classList.remove('hidden');
            setLiveState('captured');
            btnRetake.disabled = false;
            btnUploadCapture.disabled = false;
            btnCapture.disabled = true;
            video.pause();
        });

        btnRetake.addEventListener('click', async () => {
            if (!stream) await startLive();
            previewWrap.classList.add('hidden');
            btnCapture.disabled = false;
            btnRetake.disabled = true;
            btnUploadCapture.disabled = true;
            setLiveState('active');
            video.play();
        });

        // Submit capturedBlob to /scan with language -> replace document with returned HTML view
        btnUploadCapture.addEventListener('click', async () => {
            if (!capturedBlob) return;
            const lang = qs('#lang-camera').value;
            const formData = new FormData();
            formData.append('lang', lang);
            formData.append('file', asFile(capturedBlob, `capture-${Date.now()}.jpg`));
            await submitAndReplace(formData, (document.getElementById('form-upload')?.getAttribute('action')) || '/scan');
            stopLive();
        });

        // Keep native capture language in sync
        const langCameraSel = qs('#lang-camera');
        const langNative = qs('#lang-native');
        const syncLang = () => {
            langNative.value = langCameraSel.value;
        };
        langCameraSel.addEventListener('change', syncLang);
        syncLang();

        // Native capture preview and client-side optimization, then native form submit
        const nativeForm = qs('#form-native');
        const nativeInput = qs('#file-native');
        const nativePreviewWrap = qs('#nativePreviewWrap');
        const nativePreview = qs('#nativePreview');

        if (nativeInput) {
            nativeInput.addEventListener('change', async () => {
                const orig = nativeInput.files && nativeInput.files[0];
                if (!orig) {
                    nativePreviewWrap.classList.add('hidden');
                    return;
                }
                const processed = await blobFromSource(orig, {maxDim: 1600, quality: 0.85});
                nativePreview.src = processed.previewURL;
                nativePreviewWrap.classList.remove('hidden');
                // Replace the file input with optimized file so form posts directly to Spring controller
                const dt = new DataTransfer();
                dt.items.add(asFile(processed.blob, `capture-${Date.now()}.jpg`));
                nativeInput.files = dt.files;
            });
        }

        nativeForm.addEventListener('submit', () => { /* allow normal form POST -> controller returns a view */
        });

        // Run capability check on first open of Camera tab
        let checked = false;
        tabCamera.addEventListener('click', async () => {
            if (!checked) {
                checked = true;
                await checkCameraSupport();
            }
        });

        // If user lands directly on Camera tab via deep-linking, still check
        if (window.location.hash === '#camera') {
            selectTab('camera');
            checkCameraSupport();
        }

        // Clean up camera on page unload / tab switch
        window.addEventListener('pagehide', () => {
            stopLive();
        });
        tabUpload.addEventListener('click', stopLive);
    </script>
</main>
</body>
</html>